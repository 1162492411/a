---
title: "Hystrix熔断器"
date: 2020-12-21T21:52:02+08:00
draft: false
toc: true
categories:
  - 熔断
tags:
  - 服务高可用
  - 熔断
---
# 熔断器

## 状态及转换

Hystrix提供的熔断器具有自我反馈，自我恢复的功能，Hystrix会根据调用接口的情况，让熔断器在closed,open,half-open三种状态之间自动切换,三种状态简要说明如下:

* closed : 代表关闭熔断,默认状态,在此期间执行远程调用方法
* open : 代表打开熔断,在此期间执行本地降级策略,不执行远程调用
* half-open : 代表中间状态,在此期间,先执行远程调用,如果成功,下次继续执行远程调用,如果失败,转换为open状态



1)正常状态下为closed状态,若访问接口超过设置阈值且错误请求数比例达到设置值时,转换为open状态,时间段从0开始(打开熔断)

2)保持open状态一个时间段;

3)下个时间段后,状态自动转换为half-open,在此期间,

​    3.1)如果第一次请求时接口失败,则转换为open状态,时间段从0开始,

​    3.2)如果请求数量达到设置阈值且错误请求书比例未达到设置值时,转换状态为closed,时间段从0开始(恢复正常),

​    3.3)如果请求数量没有达到阈值, 一直保持half-open状态



## 核心流程

1. 将远程服务调用逻辑封装进一个HystrixCommand。
2. 对于每次服务调用可以使用同步或异步机制，对应执行execute()或queue()。
3. 判断熔断器(circuit-breaker)是否打开或者半打开状态，如果打开跳到步骤8，进行回退策略，如果关闭进入步骤4。
4. 判断线程池/队列/信号量（使用了舱壁隔离模式）是否跑满，如果跑满进入回退步骤8，否则继续后续步骤5。
5. run方法中执行了实际的服务调用。 
   a. 服务调用发生超时时，进入步骤8。
6. 判断run方法中的代码是否执行成功。 
   a. 执行成功返回结果。 
   b. 执行中出现错误则进入步骤8。
7. 所有的运行状态(成功，失败，拒绝，超时)上报给熔断器，用于统计从而影响熔断器状态。
8. 进入getFallback()回退逻辑。 
   a. 没有实现getFallback()回退逻辑的调用将直接抛出异常。 
   b. 回退逻辑调用成功直接返回。 
   c. 回退逻辑调用失败抛出异常。
9. 返回执行成功结果。
